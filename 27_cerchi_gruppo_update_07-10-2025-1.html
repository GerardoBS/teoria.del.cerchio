<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Test dei cerchi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --max-content: 1100px;
      --card-bg: #fff;
      --muted: #555;
      --line: #ddd;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;margin:16px;line-height:1.45;color:#222;background:#fafafa}
    h1{text-align:center;margin:8px 0 16px}
    h2{margin:28px 0 12px}
    h3{margin:18px 0 8px}

    .container{max-width:var(--max-content);margin:0 auto;padding:0 10px}
    .card{background:var(--card-bg);border:1px solid var(--line);border-radius:10px;padding:12px 14px;margin:12px 0}

    /* layout colonne responsive */
    .row{display:flex;flex-wrap:wrap;gap:16px;align-items:flex-start}
    .col{flex:1 1 520px;min-width:300px}

    /* Evita tagli nei form/questionari */
    .q-set{overflow:visible}
    fieldset{min-width:0} /* fix Safari */
    .q-set fieldset{border:1px solid var(--line);border-radius:10px;padding:10px 12px;margin:12px 0;background:#fff}
    .q-set legend{font-weight:600}

    /* Domande verticali: testo sopra, 5 opzioni sotto in colonna */
    .q-item{margin:10px 0}
    .q-text{display:block;margin-bottom:6px}
    .q-options label{display:block;margin:3px 0;white-space:nowrap}
    .q-options input{margin-right:6px}

    /* Cerchi SVG sempre completi e centrati */
    .tcv-svg{
      width:min(100%, 720px);
      aspect-ratio: 1 / 1;
      display:block;
      margin:18px auto 10px auto;
      background:transparent;
    }

    .legend{font-size:0.95rem;color:#333;margin:8px auto;max-width:720px}
    .muted{color:var(--muted)}

    /* Input numerici */
    input[type="number"]{width:100%;max-width:200px;padding:6px 8px;border:1px solid #ccc;border-radius:8px}

    /* Bottoni */
    .btn{padding:8px 12px;border:1px solid #bbb;border-radius:10px;background:#fff;cursor:pointer}
    .btn:hover{background:#f3f3f3}
    .btn-danger{border-color:#e57373;color:#c62828}
    .center{text-align:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>Test dei cerchi</h1>
    <div class="center" style="margin-bottom:10px">
      <button class="btn btn-danger" onclick="resetAll()">Reset totale</button>
    </div>
    <div class="card">
      <h2>Test del cerchio visivo</h2>
      <p class="muted">
        Inserisci i tuoi punti sul cerchio (le etichette “Id” e “Or” appaiono senza mostrare i gradi).
      </p>

      <p><b>Domanda 1</b> — “Pensa, in base alle tue convinzioni e al tuo personale punto di vista, a come attualmente percepisci la tua identità di genere. Più maschile o più femminile o neutra? In quale punto della semicirconferenza superiore ti puoi collocare nell’ambito della femminilità o della mascolinità o della zona neutra/intermedia?”</p>
      <div class="row">
        <div class="col">
          <label for="vis-id" class="q-text">Identità (0°–180°):</label>
          <input id="vis-id" type="number" inputmode="numeric" min="0" max="180" step="1" placeholder="0–180" />
        </div>
      </div>

      <p><b>Domanda 2</b> — “Pensa verso quale genere - maschile, femminile o neutro - percepisci maggiormente il tuo orientamento sessuale o verso il quale senti più attrazione sessuale, sentimentale, emotiva, affettiva o erotica. In quale punto della semicirconferenza inferiore puoi collocare il tuo orientamento/attrazione?”</p>
      <div class="row">
        <div class="col">
          <label for="vis-or" class="q-text">Orientamento (180°–360°):</label>
          <input id="vis-or" type="number" inputmode="numeric" min="180" max="360" step="1" placeholder="180–360" />
        </div>
      </div>

      <!-- Cerchio -->
      <svg id="svg1" class="tcv-svg" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet" aria-label="Cerchio visivo"></svg>
      <div class="legend">Legenda: Id = posizione scelta per l’identità di genere; Or = posizione scelta per l’orientamento sessuale.</div>
      <div class="center">
        <button class="btn" onclick="resetVisivo()">Reset test visivo</button>
      </div>
    </div>
    <div class="card">
      <h2>Test individuale con miniquestionari</h2>

      <!-- Questionari AFFIANCATI su 2 colonne (Qo intero visibile) -->
      <div class="row q-set" id="form2" style="align-items:stretch">
        <div class="col">
          <fieldset>
            <legend>Questionario Qi (Identità)</legend>

            <div class="q-item">
              <span class="q-text">Qi1. Quando penso a me stessə, percepisco in me una dimensione maschile.</span>
              <div class="q-options">
                <label><input type="radio" name="qi1" value="1">1</label>
                <label><input type="radio" name="qi1" value="2">2</label>
                <label><input type="radio" name="qi1" value="3">3</label>
                <label><input type="radio" name="qi1" value="4">4</label>
                <label><input type="radio" name="qi1" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qi2. Quando penso a me stessə, percepisco in me una dimensione femminile.</span>
              <div class="q-options">
                <label><input type="radio" name="qi2" value="1">1</label>
                <label><input type="radio" name="qi2" value="2">2</label>
                <label><input type="radio" name="qi2" value="3">3</label>
                <label><input type="radio" name="qi2" value="4">4</label>
                <label><input type="radio" name="qi2" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qi3. Mi riconosco più facilmente in caratteristiche o qualità maschili.</span>
              <div class="q-options">
                <label><input type="radio" name="qi3" value="1">1</label>
                <label><input type="radio" name="qi3" value="2">2</label>
                <label><input type="radio" name="qi3" value="3">3</label>
                <label><input type="radio" name="qi3" value="4">4</label>
                <label><input type="radio" name="qi3" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qi4. Mi riconosco più facilmente in caratteristiche o qualità femminili.</span>
              <div class="q-options">
                <label><input type="radio" name="qi4" value="1">1</label>
                <label><input type="radio" name="qi4" value="2">2</label>
                <label><input type="radio" name="qi4" value="3">3</label>
                <label><input type="radio" name="qi4" value="4">4</label>
                <label><input type="radio" name="qi4" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qi5. Quanto senti fluida la tua identità di genere?</span>
              <div class="q-options">
                <label><input type="radio" name="qi5" value="1">1</label>
                <label><input type="radio" name="qi5" value="2">2</label>
                <label><input type="radio" name="qi5" value="3">3</label>
                <label><input type="radio" name="qi5" value="4">4</label>
                <label><input type="radio" name="qi5" value="5">5</label>
              </div>
            </div>
          </fieldset>
        </div>

        <div class="col">
          <fieldset>
            <legend>Questionario Qo (Orientamento)</legend>

            <div class="q-item">
              <span class="q-text">Qo1. Mi sento attrattə verso caratteristiche maschili.</span>
              <div class="q-options">
                <label><input type="radio" name="qo1" value="1">1</label>
                <label><input type="radio" name="qo1" value="2">2</label>
                <label><input type="radio" name="qo1" value="3">3</label>
                <label><input type="radio" name="qo1" value="4">4</label>
                <label><input type="radio" name="qo1" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qo2. Mi sento attrattə verso caratteristiche femminili.</span>
              <div class="q-options">
                <label><input type="radio" name="qo2" value="1">1</label>
                <label><input type="radio" name="qo2" value="2">2</label>
                <label><input type="radio" name="qo2" value="3">3</label>
                <label><input type="radio" name="qo2" value="4">4</label>
                <label><input type="radio" name="qo2" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qo3. L’attrazione per il maschile è significativa nella mia vita.</span>
              <div class="q-options">
                <label><input type="radio" name="qo3" value="1">1</label>
                <label><input type="radio" name="qo3" value="2">2</label>
                <label><input type="radio" name="qo3" value="3">3</label>
                <label><input type="radio" name="qo3" value="4">4</label>
                <label><input type="radio" name="qo3" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qo4. L’attrazione per il femminile è significativa nella mia vita.</span>
              <div class="q-options">
                <label><input type="radio" name="qo4" value="1">1</label>
                <label><input type="radio" name="qo4" value="2">2</label>
                <label><input type="radio" name="qo4" value="3">3</label>
                <label><input type="radio" name="qo4" value="4">4</label>
                <label><input type="radio" name="qo4" value="5">5</label>
              </div>
            </div>

            <div class="q-item">
              <span class="q-text">Qo5. Quanto senti fluido il tuo orientamento?</span>
              <div class="q-options">
                <label><input type="radio" name="qo5" value="1">1</label>
                <label><input type="radio" name="qo5" value="2">2</label>
                <label><input type="radio" name="qo5" value="3">3</label>
                <label><input type="radio" name="qo5" value="4">4</label>
                <label><input type="radio" name="qo5" value="5">5</label>
              </div>
            </div>
          </fieldset>
        </div>
      </div>

      <!-- Cerchio dopo i due questionari -->
      <svg id="svg2" class="tcv-svg" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet" aria-label="Cerchio individuale"></svg>
      <div class="legend">Legenda: punti gialli <b>F</b> = posizioni corrette verso la fluidità in base alle risposte numero 5 (Qi5 e Qo5) dei due questionari.</div>
      <div class="center">
        <button class="btn" onclick="resetInd()">Reset test individuale</button>
      </div>
    </div>
    <div class="card">
      <h2>Test del cerchio per coppie anche di amici</h2>

      <div id="form3" class="q-set">
        <!-- Partner 1 -->
        <div class="row" style="align-items:stretch">
          <div class="col">
            <fieldset>
              <legend>Questionari per il Partner 1 — 1Qi</legend>

              <div class="q-item">
                <span class="q-text">1Qi1. Quando penso a me stessə (partner 1), percepisco in me una dimensione maschile.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qi1" value="1">1</label>
                  <label><input type="radio" name="1qi1" value="2">2</label>
                  <label><input type="radio" name="1qi1" value="3">3</label>
                  <label><input type="radio" name="1qi1" value="4">4</label>
                  <label><input type="radio" name="1qi1" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qi2. Quando penso a me stessə (partner 1), percepisco in me una dimensione femminile.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qi2" value="1">1</label>
                  <label><input type="radio" name="1qi2" value="2">2</label>
                  <label><input type="radio" name="1qi2" value="3">3</label>
                  <label><input type="radio" name="1qi2" value="4">4</label>
                  <label><input type="radio" name="1qi2" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qi3. Mi riconosco più facilmente in caratteristiche o qualità maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qi3" value="1">1</label>
                  <label><input type="radio" name="1qi3" value="2">2</label>
                  <label><input type="radio" name="1qi3" value="3">3</label>
                  <label><input type="radio" name="1qi3" value="4">4</label>
                  <label><input type="radio" name="1qi3" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qi4. Mi riconosco più facilmente in caratteristiche o qualità femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qi4" value="1">1</label>
                  <label><input type="radio" name="1qi4" value="2">2</label>
                  <label><input type="radio" name="1qi4" value="3">3</label>
                  <label><input type="radio" name="1qi4" value="4">4</label>
                  <label><input type="radio" name="1qi4" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qi5. Quanto senti fluida la tua identità di genere?</span>
                <div class="q-options">
                  <label><input type="radio" name="1qi5" value="1">1</label>
                  <label><input type="radio" name="1qi5" value="2">2</label>
                  <label><input type="radio" name="1qi5" value="3">3</label>
                  <label><input type="radio" name="1qi5" value="4">4</label>
                  <label><input type="radio" name="1qi5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="col">
            <fieldset>
              <legend>Questionari per il Partner 1 — 1Qo</legend>

              <div class="q-item">
                <span class="q-text">1Qo1. Mi sento attrattə (partner 1) verso caratteristiche maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qo1" value="1">1</label>
                  <label><input type="radio" name="1qo1" value="2">2</label>
                  <label><input type="radio" name="1qo1" value="3">3</label>
                  <label><input type="radio" name="1qo1" value="4">4</label>
                  <label><input type="radio" name="1qo1" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qo2. Mi sento attrattə (partner 1) verso caratteristiche femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qo2" value="1">1</label>
                  <label><input type="radio" name="1qo2" value="2">2</label>
                  <label><input type="radio" name="1qo2" value="3">3</label>
                  <label><input type="radio" name="1qo2" value="4">4</label>
                  <label><input type="radio" name="1qo2" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qo3. L’attrazione per il maschile (partner 1) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qo3" value="1">1</label>
                  <label><input type="radio" name="1qo3" value="2">2</label>
                  <label><input type="radio" name="1qo3" value="3">3</label>
                  <label><input type="radio" name="1qo3" value="4">4</label>
                  <label><input type="radio" name="1qo3" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qo4. L’attrazione per il femminile (partner 1) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="1qo4" value="1">1</label>
                  <label><input type="radio" name="1qo4" value="2">2</label>
                  <label><input type="radio" name="1qo4" value="3">3</label>
                  <label><input type="radio" name="1qo4" value="4">4</label>
                  <label><input type="radio" name="1qo4" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">1Qo5. Quanto senti fluido il tuo orientamento?</span>
                <div class="q-options">
                  <label><input type="radio" name="1qo5" value="1">1</label>
                  <label><input type="radio" name="1qo5" value="2">2</label>
                  <label><input type="radio" name="1qo5" value="3">3</label>
                  <label><input type="radio" name="1qo5" value="4">4</label>
                  <label><input type="radio" name="1qo5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>
        </div>

        <!-- Partner 2 -->
        <div class="row" style="align-items:stretch">
          <div class="col">
            <fieldset>
              <legend>Questionari per il Partner 2 — 2Qi</legend>

              <div class="q-item">
                <span class="q-text">2Qi1. Quando penso a me stessə (partner 2), percepisco in me una dimensione maschile.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qi1" value="1">1</label>
                  <label><input type="radio" name="2qi1" value="2">2</label>
                  <label><input type="radio" name="2qi1" value="3">3</label>
                  <label><input type="radio" name="2qi1" value="4">4</label>
                  <label><input type="radio" name="2qi1" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qi2. Quando penso a me stessə (partner 2), percepisco in me una dimensione femminile.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qi2" value="1">1</label>
                  <label><input type="radio" name="2qi2" value="2">2</label>
                  <label><input type="radio" name="2qi2" value="3">3</label>
                  <label><input type="radio" name="2qi2" value="4">4</label>
                  <label><input type="radio" name="2qi2" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qi3. Mi riconosco più facilmente in caratteristiche o qualità maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qi3" value="1">1</label>
                  <label><input type="radio" name="2qi3" value="2">2</label>
                  <label><input type="radio" name="2qi3" value="3">3</label>
                  <label><input type="radio" name="2qi3" value="4">4</label>
                  <label><input type="radio" name="2qi3" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qi4. Mi riconosco più facilmente in caratteristiche o qualità femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qi4" value="1">1</label>
                  <label><input type="radio" name="2qi4" value="2">2</label>
                  <label><input type="radio" name="2qi4" value="3">3</label>
                  <label><input type="radio" name="2qi4" value="4">4</label>
                  <label><input type="radio" name="2qi4" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qi5. Quanto senti fluida la tua identità di genere?</span>
                <div class="q-options">
                  <label><input type="radio" name="2qi5" value="1">1</label>
                  <label><input type="radio" name="2qi5" value="2">2</label>
                  <label><input type="radio" name="2qi5" value="3">3</label>
                  <label><input type="radio" name="2qi5" value="4">4</label>
                  <label><input type="radio" name="2qi5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="col">
            <fieldset>
              <legend>Questionari per il Partner 2 — 2Qo</legend>

              <div class="q-item">
                <span class="q-text">2Qo1. Mi sento attrattə (partner 2) verso caratteristiche maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qo1" value="1">1</label>
                  <label><input type="radio" name="2qo1" value="2">2</label>
                  <label><input type="radio" name="2qo1" value="3">3</label>
                  <label><input type="radio" name="2qo1" value="4">4</label>
                  <label><input type="radio" name="2qo1" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qo2. Mi sento attrattə (partner 2) verso caratteristiche femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qo2" value="1">1</label>
                  <label><input type="radio" name="2qo2" value="2">2</label>
                  <label><input type="radio" name="2qo2" value="3">3</label>
                  <label><input type="radio" name="2qo2" value="4">4</label>
                  <label><input type="radio" name="2qo2" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qo3. L’attrazione per il maschile (partner 2) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qo3" value="1">1</label>
                  <label><input type="radio" name="2qo3" value="2">2</label>
                  <label><input type="radio" name="2qo3" value="3">3</label>
                  <label><input type="radio" name="2qo3" value="4">4</label>
                  <label><input type="radio" name="2qo3" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qo4. L’attrazione per il femminile (partner 2) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="2qo4" value="1">1</label>
                  <label><input type="radio" name="2qo4" value="2">2</label>
                  <label><input type="radio" name="2qo4" value="3">3</label>
                  <label><input type="radio" name="2qo4" value="4">4</label>
                  <label><input type="radio" name="2qo4" value="5">5</label>
                </div>
              </div>

              <div class="q-item">
                <span class="q-text">2Qo5. Quanto senti fluido il tuo orientamento?</span>
                <div class="q-options">
                  <label><input type="radio" name="2qo5" value="1">1</label>
                  <label><input type="radio" name="2qo5" value="2">2</label>
                  <label><input type="radio" name="2qo5" value="3">3</label>
                  <label><input type="radio" name="2qo5" value="4">4</label>
                  <label><input type="radio" name="2qo5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </div>

      <!-- Cerchio dopo i questionari P1+P2 -->
      <svg id="svg3" class="tcv-svg" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet" aria-label="Cerchio coppia"></svg>
      <div class="legend" id="pair-metrics"></div>
      <div class="center" style="margin-bottom:12px">
        <button class="btn" onclick="resetCoppia()">Reset test coppia</button>
      </div>

      <!-- Selettore tipo relazione + tabella α/β -->
      <h3>Modifica parametri α e β</h3>
      <label for="rel-type" style="display:inline-block;margin:6px 0;">Tipo di relazione:</label>
      <select id="rel-type" style="margin-left:8px;">
        <option value="am" selected>Amicizia (α=0.8, β=0.2)</option>
        <option value="ro">Coppia romantica (α=0.4, β=0.6)</option>
        <option value="st">Coppia stabilizzata (α=0.6, β=0.4)</option>
      </select>

      <table border="1" cellpadding="5" style="border-collapse:collapse; margin-top:8px">
        <tr><th>Tipo di coppia</th><th>α</th><th>β</th></tr>
        <tr><td>Amicizia</td>
          <td><input type="number" id="alpha-am" min="0" max="1" step="0.05" value="0.8"></td>
          <td><input type="number" id="beta-am"  min="0" max="1" step="0.05" value="0.2"></td></tr>
        <tr><td>Coppia romantica</td>
          <td><input type="number" id="alpha-ro" min="0" max="1" step="0.05" value="0.4"></td>
          <td><input type="number" id="beta-ro"  min="0" max="1" step="0.05" value="0.6"></td></tr>
        <tr><td>Coppia stabilizzata</td>
          <td><input type="number" id="alpha-st" min="0" max="1" step="0.05" value="0.6"></td>
          <td><input type="number" id="beta-st"  min="0" max="1" step="0.05" value="0.4"></td></tr>
      </table>
    </div>
    <!-- ===================================================== -->
    <!-- ===============   PARTE 5A (inizio)   =============== -->
    <!-- ===================================================== -->
    <div class="card">
      <h2>Test del cerchio per gruppi di amici, max 3</h2>

      <form id="form4" class="q-set">
        <!-- ==================== P1 ==================== -->
        <div class="row">
          <div class="col">
            <fieldset>
              <legend>P1 — 1Qi (Identità)</legend>
              <div class="q-item"><span class="q-text">1Qi1. Quando penso a me stessə (partner 1), percepisco in me una dimensione maschile.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qi1" value="1">1</label>
                  <label><input type="radio" name="g1qi1" value="2">2</label>
                  <label><input type="radio" name="g1qi1" value="3">3</label>
                  <label><input type="radio" name="g1qi1" value="4">4</label>
                  <label><input type="radio" name="g1qi1" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qi2. Quando penso a me stessə (partner 1), percepisco in me una dimensione femminile.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qi2" value="1">1</label>
                  <label><input type="radio" name="g1qi2" value="2">2</label>
                  <label><input type="radio" name="g1qi2" value="3">3</label>
                  <label><input type="radio" name="g1qi2" value="4">4</label>
                  <label><input type="radio" name="g1qi2" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qi3. Mi riconosco più facilmente in caratteristiche o qualità maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qi3" value="1">1</label>
                  <label><input type="radio" name="g1qi3" value="2">2</label>
                  <label><input type="radio" name="g1qi3" value="3">3</label>
                  <label><input type="radio" name="g1qi3" value="4">4</label>
                  <label><input type="radio" name="g1qi3" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qi4. Mi riconosco più facilmente in caratteristiche o qualità femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qi4" value="1">1</label>
                  <label><input type="radio" name="g1qi4" value="2">2</label>
                  <label><input type="radio" name="g1qi4" value="3">3</label>
                  <label><input type="radio" name="g1qi4" value="4">4</label>
                  <label><input type="radio" name="g1qi4" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qi5. Quanto senti fluida la tua identità di genere?</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qi5" value="1">1</label>
                  <label><input type="radio" name="g1qi5" value="2">2</label>
                  <label><input type="radio" name="g1qi5" value="3">3</label>
                  <label><input type="radio" name="g1qi5" value="4">4</label>
                  <label><input type="radio" name="g1qi5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="col">
            <fieldset>
              <legend>P1 — 1Qo (Orientamento)</legend>
              <div class="q-item"><span class="q-text">1Qo1. Mi sento attrattə (partner 1) verso caratteristiche maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qo1" value="1">1</label>
                  <label><input type="radio" name="g1qo1" value="2">2</label>
                  <label><input type="radio" name="g1qo1" value="3">3</label>
                  <label><input type="radio" name="g1qo1" value="4">4</label>
                  <label><input type="radio" name="g1qo1" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qo2. Mi sento attrattə (partner 1) verso caratteristiche femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qo2" value="1">1</label>
                  <label><input type="radio" name="g1qo2" value="2">2</label>
                  <label><input type="radio" name="g1qo2" value="3">3</label>
                  <label><input type="radio" name="g1qo2" value="4">4</label>
                  <label><input type="radio" name="g1qo2" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qo3. L’attrazione per il maschile (partner 1) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qo3" value="1">1</label>
                  <label><input type="radio" name="g1qo3" value="2">2</label>
                  <label><input type="radio" name="g1qo3" value="3">3</label>
                  <label><input type="radio" name="g1qo3" value="4">4</label>
                  <label><input type="radio" name="g1qo3" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qo4. L’attrazione per il femminile (partner 1) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qo4" value="1">1</label>
                  <label><input type="radio" name="g1qo4" value="2">2</label>
                  <label><input type="radio" name="g1qo4" value="3">3</label>
                  <label><input type="radio" name="g1qo4" value="4">4</label>
                  <label><input type="radio" name="g1qo4" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">1Qo5. Quanto senti fluido il tuo orientamento?</span>
                <div class="q-options">
                  <label><input type="radio" name="g1qo5" value="1">1</label>
                  <label><input type="radio" name="g1qo5" value="2">2</label>
                  <label><input type="radio" name="g1qo5" value="3">3</label>
                  <label><input type="radio" name="g1qo5" value="4">4</label>
                  <label><input type="radio" name="g1qo5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>
        </div>

        <!-- ==================== P2 seguirà in parte 5B ==================== -->
        <!-- ==================== P2 (continua) ==================== -->
        <div class="row">
          <div class="col">
            <fieldset>
              <legend>P2 — 2Qi (Identità)</legend>
              <div class="q-item"><span class="q-text">2Qi1. Quando penso a me stessə (partner 2), percepisco in me una dimensione maschile.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qi1" value="1">1</label>
                  <label><input type="radio" name="g2qi1" value="2">2</label>
                  <label><input type="radio" name="g2qi1" value="3">3</label>
                  <label><input type="radio" name="g2qi1" value="4">4</label>
                  <label><input type="radio" name="g2qi1" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qi2. Quando penso a me stessə (partner 2), percepisco in me una dimensione femminile.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qi2" value="1">1</label>
                  <label><input type="radio" name="g2qi2" value="2">2</label>
                  <label><input type="radio" name="g2qi2" value="3">3</label>
                  <label><input type="radio" name="g2qi2" value="4">4</label>
                  <label><input type="radio" name="g2qi2" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qi3. Mi riconosco più facilmente in caratteristiche o qualità maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qi3" value="1">1</label>
                  <label><input type="radio" name="g2qi3" value="2">2</label>
                  <label><input type="radio" name="g2qi3" value="3">3</label>
                  <label><input type="radio" name="g2qi3" value="4">4</label>
                  <label><input type="radio" name="g2qi3" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qi4. Mi riconosco più facilmente in caratteristiche o qualità femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qi4" value="1">1</label>
                  <label><input type="radio" name="g2qi4" value="2">2</label>
                  <label><input type="radio" name="g2qi4" value="3">3</label>
                  <label><input type="radio" name="g2qi4" value="4">4</label>
                  <label><input type="radio" name="g2qi4" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qi5. Quanto senti fluida la tua identità di genere?</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qi5" value="1">1</label>
                  <label><input type="radio" name="g2qi5" value="2">2</label>
                  <label><input type="radio" name="g2qi5" value="3">3</label>
                  <label><input type="radio" name="g2qi5" value="4">4</label>
                  <label><input type="radio" name="g2qi5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="col">
            <fieldset>
              <legend>P2 — 2Qo (Orientamento)</legend>
              <div class="q-item"><span class="q-text">2Qo1. Mi sento attrattə (partner 2) verso caratteristiche maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qo1" value="1">1</label>
                  <label><input type="radio" name="g2qo1" value="2">2</label>
                  <label><input type="radio" name="g2qo1" value="3">3</label>
                  <label><input type="radio" name="g2qo1" value="4">4</label>
                  <label><input type="radio" name="g2qo1" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qo2. Mi sento attrattə (partner 2) verso caratteristiche femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qo2" value="1">1</label>
                  <label><input type="radio" name="g2qo2" value="2">2</label>
                  <label><input type="radio" name="g2qo2" value="3">3</label>
                  <label><input type="radio" name="g2qo2" value="4">4</label>
                  <label><input type="radio" name="g2qo2" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qo3. L’attrazione per il maschile (partner 2) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qo3" value="1">1</label>
                  <label><input type="radio" name="g2qo3" value="2">2</label>
                  <label><input type="radio" name="g2qo3" value="3">3</label>
                  <label><input type="radio" name="g2qo3" value="4">4</label>
                  <label><input type="radio" name="g2qo3" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qo4. L’attrazione per il femminile (partner 2) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qo4" value="1">1</label>
                  <label><input type="radio" name="g2qo4" value="2">2</label>
                  <label><input type="radio" name="g2qo4" value="3">3</label>
                  <label><input type="radio" name="g2qo4" value="4">4</label>
                  <label><input type="radio" name="g2qo4" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">2Qo5. Quanto senti fluido il tuo orientamento?</span>
                <div class="q-options">
                  <label><input type="radio" name="g2qo5" value="1">1</label>
                  <label><input type="radio" name="g2qo5" value="2">2</label>
                  <label><input type="radio" name="g2qo5" value="3">3</label>
                  <label><input type="radio" name="g2qo5" value="4">4</label>
                  <label><input type="radio" name="g2qo5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>
        </div>

        <!-- ==================== P3 ==================== -->
        <div class="row">
          <div class="col">
            <fieldset>
              <legend>P3 — 3Qi (Identità)</legend>
              <div class="q-item"><span class="q-text">3Qi1. Quando penso a me stessə (partner 3), percepisco in me una dimensione maschile.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qi1" value="1">1</label>
                  <label><input type="radio" name="g3qi1" value="2">2</label>
                  <label><input type="radio" name="g3qi1" value="3">3</label>
                  <label><input type="radio" name="g3qi1" value="4">4</label>
                  <label><input type="radio" name="g3qi1" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qi2. Quando penso a me stessə (partner 3), percepisco in me una dimensione femminile.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qi2" value="1">1</label>
                  <label><input type="radio" name="g3qi2" value="2">2</label>
                  <label><input type="radio" name="g3qi2" value="3">3</label>
                  <label><input type="radio" name="g3qi2" value="4">4</label>
                  <label><input type="radio" name="g3qi2" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qi3. Mi riconosco più facilmente in caratteristiche o qualità maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qi3" value="1">1</label>
                  <label><input type="radio" name="g3qi3" value="2">2</label>
                  <label><input type="radio" name="g3qi3" value="3">3</label>
                  <label><input type="radio" name="g3qi3" value="4">4</label>
                  <label><input type="radio" name="g3qi3" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qi4. Mi riconosco più facilmente in caratteristiche o qualità femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qi4" value="1">1</label>
                  <label><input type="radio" name="g3qi4" value="2">2</label>
                  <label><input type="radio" name="g3qi4" value="3">3</label>
                  <label><input type="radio" name="g3qi4" value="4">4</label>
                  <label><input type="radio" name="g3qi4" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qi5. Quanto senti fluida la tua identità di genere?</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qi5" value="1">1</label>
                  <label><input type="radio" name="g3qi5" value="2">2</label>
                  <label><input type="radio" name="g3qi5" value="3">3</label>
                  <label><input type="radio" name="g3qi5" value="4">4</label>
                  <label><input type="radio" name="g3qi5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>

          <div class="col">
            <fieldset>
              <legend>P3 — 3Qo (Orientamento)</legend>
              <div class="q-item"><span class="q-text">3Qo1. Mi sento attrattə (partner 3) verso caratteristiche maschili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qo1" value="1">1</label>
                  <label><input type="radio" name="g3qo1" value="2">2</label>
                  <label><input type="radio" name="g3qo1" value="3">3</label>
                  <label><input type="radio" name="g3qo1" value="4">4</label>
                  <label><input type="radio" name="g3qo1" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qo2. Mi sento attrattə (partner 3) verso caratteristiche femminili.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qo2" value="1">1</label>
                  <label><input type="radio" name="g3qo2" value="2">2</label>
                  <label><input type="radio" name="g3qo2" value="3">3</label>
                  <label><input type="radio" name="g3qo2" value="4">4</label>
                  <label><input type="radio" name="g3qo2" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qo3. L’attrazione per il maschile (partner 3) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qo3" value="1">1</label>
                  <label><input type="radio" name="g3qo3" value="2">2</label>
                  <label><input type="radio" name="g3qo3" value="3">3</label>
                  <label><input type="radio" name="g3qo3" value="4">4</label>
                  <label><input type="radio" name="g3qo3" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qo4. L’attrazione per il femminile (partner 3) è significativa nella mia vita.</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qo4" value="1">1</label>
                  <label><input type="radio" name="g3qo4" value="2">2</label>
                  <label><input type="radio" name="g3qo4" value="3">3</label>
                  <label><input type="radio" name="g3qo4" value="4">4</label>
                  <label><input type="radio" name="g3qo4" value="5">5</label>
                </div>
              </div>
              <div class="q-item"><span class="q-text">3Qo5. Quanto senti fluido il tuo orientamento?</span>
                <div class="q-options">
                  <label><input type="radio" name="g3qo5" value="1">1</label>
                  <label><input type="radio" name="g3qo5" value="2">2</label>
                  <label><input type="radio" name="g3qo5" value="3">3</label>
                  <label><input type="radio" name="g3qo5" value="4">4</label>
                  <label><input type="radio" name="g3qo5" value="5">5</label>
                </div>
              </div>
            </fieldset>
          </div>
        </div>
      </form>

      <!-- Cerchio del gruppo + etichette -->
      <svg id="svg4" class="tcv-svg" viewBox="0 0 500 500" preserveAspectRatio="xMidYMid meet" aria-label="Cerchio gruppo"></svg>
      <div class="legend" id="group-metrics"></div>
      <div class="center" style="margin-bottom:12px">
        <button class="btn" onclick="resetGruppo()">Reset test gruppo</button>
      </div>

      <h3>Modifica parametri α e β (Amicizia)</h3>
      <table border="1" cellpadding="5" style="border-collapse:collapse">
        <tr><th>Amicizia</th><th>α</th><th>β</th></tr>
        <tr>
          <td>Valori</td>
          <td><input type="number" id="alpha-gr" min="0" max="1" step="0.05" value="0.8"></td>
          <td><input type="number" id="beta-gr"  min="0" max="1" step="0.05" value="0.2"></td>
        </tr>
      </table>
    </div>

    <!-- ================== SCRIPT COMPLETO ================== -->
    <script>
    (function(){
      /* ===== Helpers ===== */
      const byId=id=>document.getElementById(id);
      const $$=sel=>Array.from(document.querySelectorAll(sel));
      const rad=d=>d*Math.PI/180;
      const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
      const rescale = v => Number.isFinite(v) ? (v-1) : NaN; // 1..5 -> 0..4
      const getLikert = name => { const el=document.querySelector(`input[name="${name}"]:checked`); return el?+el.value:NaN; };

      /* --- SVG util --- */
      function polar(cx,cy,R,deg){ return { x: cx + R*Math.cos(rad(deg)), y: cy - R*Math.sin(rad(deg)) }; }
      function svgEl(tag, attrs={}){ const e=document.createElementNS("http://www.w3.org/2000/svg",tag);
        for(const k in attrs){ e.setAttribute(k, attrs[k]); } return e; }

      function drawFrame(svg){
        const cx=250, cy=250, R=200;
        svg.innerHTML="";
        // cerchio
        svg.appendChild(svgEl("circle",{cx,cy,r:R,fill:"none",stroke:"#999"}));
        // assi
        svg.appendChild(svgEl("line",{x1:cx-R,y1:cy,x2:cx+R,y2:cy,stroke:"#eee"}));
        svg.appendChild(svgEl("line",{x1:cx,y1:cy-R,x2:cx,y2:cy+R,stroke:"#eee"}));
        // diagonale 0°-360°
        const p0=polar(cx,cy,R,0), p180=polar(cx,cy,R,180);
        svg.appendChild(svgEl("line",{x1:p180.x,y1:p180.y,x2:p0.x,y2:p0.y,stroke:"#bbb","stroke-dasharray":"4 3"}));
        // tacche + gradi (ingranditi)
        for(let a=0;a<360;a+=30){
          const t1=polar(cx,cy,R,a), t0=polar(cx,cy,R-10,a);
          svg.appendChild(svgEl("line",{x1:t0.x,y1:t0.y,x2:t1.x,y2:t1.y,stroke:"#ccc"}));
          const pl=polar(cx,cy,R+22,a);
          const lbl=svgEl("text",{x:pl.x,y:pl.y,style:"font-size:16px;fill:#333;text-anchor:middle;dominant-baseline:middle"});
          lbl.textContent=(a===0)?"0°/360°":(a+"°"); svg.appendChild(lbl);
        }
        // etichette centrali
        const p90 = polar(cx,cy,R-35,90), p270=polar(cx,cy,R-35,270);
        svg.appendChild(svgEl("text",{x:p90.x,y:p90.y,style:"font-size:14px;fill:#555;text-anchor:middle;dominant-baseline:middle"})).textContent="Identità di genere";
        svg.appendChild(svgEl("text",{x:p270.x,y:p270.y,style:"font-size:14px;fill:#555;text-anchor:middle;dominant-baseline:middle"})).textContent="Orientamento/attrazione";
        // 4 quadranti (con 2 etichette su due righe nel semicerchio inferiore)
        svg.appendChild(svgEl("text",{x:cx+85,y:cy-78,style:"font-size:14px;fill:#555;text-anchor:middle"})).textContent="Mascolinità";
        svg.appendChild(svgEl("text",{x:cx-85,y:cy-78,style:"font-size:14px;fill:#555;text-anchor:middle"})).textContent="Femminilità";

        // Orientamento verso il femminile (due righe)
        const tf = svgEl("text",{x:cx-110,y:cy+48,style:"font-size:14px;fill:#555;text-anchor:middle"});
        const tf1 = svgEl("tspan",{x:cx-110,y:cy+48});  tf1.textContent="Orientamento verso";
        const tf2 = svgEl("tspan",{x:cx-110,y:cy+66});  tf2.textContent="il femminile";
        tf.appendChild(tf1); tf.appendChild(tf2); svg.appendChild(tf);

        // Orientamento verso il maschile (due righe)
        const tm = svgEl("text",{x:cx+110,y:cy+48,style:"font-size:14px;fill:#555;text-anchor:middle"});
        const tm1 = svgEl("tspan",{x:cx+110,y:cy+48});  tm1.textContent="Orientamento verso";
        const tm2 = svgEl("tspan",{x:cx+110,y:cy+66});  tm2.textContent="il maschile";
        tm.appendChild(tm1); tm.appendChild(tm2); svg.appendChild(tm);

        return {cx,cy,R};
      }

      function placeLabel(svg, ptX, ptY, textContent){
        const candidates = [
          {dx:8,dy:-8},{dx:8,dy:12},{dx:-8,dy:-8},{dx:-8,dy:12},
          {dx:14,dy:-14},{dx:14,dy:14},{dx:-14,dy:-14},{dx:-14,dy:14}
        ];
        const staticBoxes = Array.from(svg.querySelectorAll('text')).map(e=>e.getBBox());
        for(const c of candidates){
          const t = svgEl("text",{x:ptX+c.dx,y:ptY+c.dy,style:"font-size:12px;font-weight:bold;fill:#111"});
          t.textContent = textContent; svg.appendChild(t);
          const bb=t.getBBox();
          const overlap = staticBoxes.some(b => !(bb.x+bb.width<b.x||b.x+b.width<bb.x||bb.y+bb.height<b.y||b.y+b.height<bb.y));
          if(!overlap) return;
          svg.removeChild(t);
        }
        const t = svgEl("text",{x:ptX+8,y:ptY-8,style:"font-size:12px;font-weight:bold;fill:#111"});
        t.textContent=textContent; svg.appendChild(t);
      }

      function drawPoint(svg,cx,cy,R,deg,color,label){
        if(!Number.isFinite(deg)) return;
        const p = polar(cx,cy,R,deg);
        svg.appendChild(svgEl("circle",{cx:p.x,cy:p.y,r:5,fill:color,stroke:(color==="#fdd835"?"#f6a800":"none"),"stroke-width":"1"}));
        if(label) placeLabel(svg,p.x,p.y,label);
      }

// --- Minimal post-pass to keep only P*-labels from overlapping (no transforms, only x/y) ---
function resolvePointLabelCollisions(svg){
  if(!svg) return;
  const labels = Array.from(svg.querySelectorAll('text')).filter(t=>{
    const s=(t.textContent||"").trim();
    return /^P[123]_(Id|Or)$/.test(s);
  });
  if(labels.length < 2) return;

  // Deterministic order: P1 -> P2 -> P3; within same person, DOM order
  const order = t => {
    const s=t.textContent.trim();
    return s.startsWith("P1_")?1 : s.startsWith("P2_")?2 : 3;
  };
  labels.sort((a,b)=>order(a)-order(b));

  // simple AABB overlap
  const pad=1;
  const box = el => { const b=el.getBBox(); return {x:b.x-pad,y:b.y-pad,w:b.width+2*pad,h:b.height+2*pad}; };
  const hit = (A,B)=> A.x < B.x+B.w && A.x+A.w > B.x && A.y < B.y+B.h && A.y+A.h > B.y;

  // candidate nudges (small, then larger)
  const OFF=[
    {dx:0,dy:-10},{dx:10,dy:-6},{dx:-10,dy:-6},
    {dx:10,dy:8},{dx:-10,dy:8},{dx:0,dy:12},
    {dx:14,dy:0},{dx:-14,dy:0},{dx:18,dy:-12},{dx:-18,dy:-12}
  ];

  const placed=[];
  for(const t of labels){
    // original position
    const x0 = t.hasAttribute("x") ? parseFloat(t.getAttribute("x")) : NaN;
    const y0 = t.hasAttribute("y") ? parseFloat(t.getAttribute("y")) : NaN;
    if(!Number.isFinite(x0) || !Number.isFinite(y0)){
      placed.push({el:t, b:box(t)});
      continue;
    }
    let b0 = box(t);
    // if already non-overlapping w.r.t. previously placed labels, keep
    if(!placed.some(p=>hit(b0,p.b))){
      placed.push({el:t,b:b0});
      continue;
    }
    // try nudges
    let ok=false;
    for(const {dx,dy} of OFF){
      t.setAttribute("x", String(x0+dx));
      t.setAttribute("y", String(y0+dy));
      const bn = box(t);
      if(!placed.some(p=>hit(bn,p.b))){
        placed.push({el:t,b:bn});
        ok=true;
        break;
      }
    }
    if(!ok){
      // gentle fallback: small downward move
      t.setAttribute("y", String(y0+14));
      placed.push({el:t,b:box(t)});
    }
  }
}


      // --- Helpers per normalizzazione/tolleranza angolare ---
      function norm360(d){ return ((d%360)+360)%360; }
      function near(d, target, eps=2){ return Math.abs(norm360(d) - norm360(target)) <= eps; }
      function isNear0or360(d, eps=2){ return near(d,0,eps) || near(d,360,eps); }
      function isNear180(d, eps=2){ return near(d,180,eps); }

      // --- Helper: punto bicolore agli estremi (0°/360° e 180°), r=5, nessun transform ---
      function drawBiColorPoint(svg, x, y, r, colorLeft, colorRight){
        // Semicerchio sinistro: arco sinistro + linea di diametro
        const pathLeft = ["M", x, y - r, "A", r, r, 0, 0, 0, x, y + r, "L", x, y - r, "Z"].join(" ");
        svg.appendChild(svgEl("path", { d: pathLeft, fill: colorLeft }));
        // Semicerchio destro: arco destro + linea di diametro
        const pathRight = ["M", x, y - r, "A", r, r, 0, 0, 1, x, y + r, "L", x, y - r, "Z"].join(" ");
        svg.appendChild(svgEl("path", { d: pathRight, fill: colorRight }));
      }

      // --- Helper: punto solido (r=5, nessun transform) ---
      function drawSolidPoint(svg, x, y, r, color){
        svg.appendChild(svgEl("circle",{cx:x,cy:y,r:r,fill:color}));
      }
      /* ===== Formule definitive ===== */
      function calcIdentityAngle(q1,q2,q3,q4){
        const IM=(rescale(q1)||0)+(rescale(q3)||0);
        const IF=(rescale(q2)||0)+(rescale(q4)||0);
        if(IM+IF<=0) return 90;
        return clamp(90 + (90/8)*(IF-IM), 0, 180);
      }
      function calcOrientationAngle(q1,q2,q3,q4){
        const OM=(rescale(q1)||0)+(rescale(q3)||0);
        const OF=(rescale(q2)||0)+(rescale(q4)||0);
        if(OM+OF<=0) return 270;
        return clamp(270 + (90/8)*(OM-OF), 180, 360);
      }
      function applyFluidityCorrection(angle,score,target){
        if(!Number.isFinite(angle)) return angle;
        const delta = 5*Math.max(0,(score||0)-1);
        const diff  = target - angle;
        if(delta<=0) return angle;
        const step  = Math.sign(diff)*Math.min(Math.abs(diff),delta);
        const out   = angle + step;
        if(target===90)  return (diff>0)?Math.min(out,90):Math.max(out,90);
        if(target===270) return (diff>0)?Math.min(out,270):Math.max(out,270);
        return out;
      }
      const diff180 = (a,b)=>{ let d=Math.abs((a||0)-(b||0))%360; return d>180?360-d:d; };

      /* ===== Sezione 1: Visivo ===== */
      function renderVisivo(){
        const svg=byId("svg1"); if(!svg) return;
        const {cx,cy,R}=drawFrame(svg);
        const ida = byId("vis-id")?.valueAsNumber;
        const ora = byId("vis-or")?.valueAsNumber;
        if(Number.isFinite(ida) && ida>=0 && ida<=180)   drawPoint(svg,cx,cy,R,ida,"#ff8a00","Id");
        if(Number.isFinite(ora) && ora>=180 && ora<=360) drawPoint(svg,cx,cy,R,ora,"#00bcd4","Or");
      }
      function resetVisivo(){
        if(byId("vis-id")) byId("vis-id").value="";
        if(byId("vis-or")) byId("vis-or").value="";
        renderVisivo();
      }

      /* ===== Sezione 2: Individuale ===== */
      function renderInd(){
        const svg=byId("svg2"); if(!svg) return;
        const {cx,cy,R}=drawFrame(svg);

        const qi1=getLikert("qi1"), qi2=getLikert("qi2"), qi3=getLikert("qi3"), qi4=getLikert("qi4"), qi5=getLikert("qi5");
        const qo1=getLikert("qo1"), qo2=getLikert("qo2"), qo3=getLikert("qo3"), qo4=getLikert("qo4"), qo5=getLikert("qo5");

        const IM=(rescale(qi1)||0)+(rescale(qi3)||0), IF=(rescale(qi2)||0)+(rescale(qi4)||0);
        const OM=(rescale(qo1)||0)+(rescale(qo3)||0), OF=(rescale(qo2)||0)+(rescale(qo4)||0);

        const aId=calcIdentityAngle(qi1,qi2,qi3,qi4);
        const aOr=calcOrientationAngle(qo1,qo2,qo3,qo4);

        
        // 1) F gialli PRIMA (per tenerli sotto in caso di coincidenza)
        if(IM+IF>0 && Number.isFinite(qi5))
          drawPoint(svg,cx,cy,R,applyFluidityCorrection(aId,qi5,90),  "#fdd835","F");
        if(OM+OF>0 && Number.isFinite(qo5))
          drawPoint(svg,cx,cy,R,applyFluidityCorrection(aOr,qo5,270), "#fdd835","F");

        // 2) Gestione bicolore agli estremi con tolleranza (±2°)
        const hasId = (IM+IF>0);
        const hasOr = (OM+OF>0);
        if(hasId && hasOr && (
             (isNear0or360(aId) && isNear0or360(aOr)) ||
             (isNear180(aId)     && isNear180(aOr))
          )){
          const useAngle = isNear180(aId) ? 180 : 0;                // 0°/360° oppure 180°
          const p = polar(cx,cy,R,useAngle);
          drawBiColorPoint(svg, p.x, p.y, 5, "#e53935", "#1e88e5"); // metà rosso / metà blu
          // Etichette sullo stesso centro: prima Id poi Or (anti-overlap naturale)
          placeLabel(svg, p.x, p.y, "Id");
          placeLabel(svg, p.x, p.y, "Or");
        } else {
          // 3) Caso normale: Id poi Or, con etichette
          if(hasId) drawPoint(svg,cx,cy,R,aId,"#e53935","Id");
          if(hasOr) drawPoint(svg,cx,cy,R,aOr,"#1e88e5","Or");
        }

        // 4) Sposta TUTTI i cerchi gialli F all'inizio del DOM (dietro a frame e punti)
        (function(){
          const nodes = Array.from(svg.querySelectorAll('circle[fill="#fdd835"]'));
          for(const c of nodes){
            svg.insertBefore(c, svg.firstChild);
          }
        })();
      }
      function resetInd(){ $$('#form2 input[type="radio"]').forEach(i=>i.checked=false); renderInd(); }

      /* ===== Sezione 3: Coppia ===== */
      function readPairABBySelection(){
        const sel = byId('rel-type')?.value || 'am';
        const a_am=byId('alpha-am')?.valueAsNumber ?? 0.8, b_am=byId('beta-am')?.valueAsNumber ?? 0.2;
        const a_ro=byId('alpha-ro')?.valueAsNumber ?? 0.4, b_ro=byId('beta-ro')?.valueAsNumber ?? 0.6;
        const a_st=byId('alpha-st')?.valueAsNumber ?? 0.6, b_st=byId('beta-st')?.valueAsNumber ?? 0.4;
        let a=0.8,b=0.2;
        if(sel==='am'){ a=a_am; b=b_am; }
        else if(sel==='ro'){ a=a_ro; b=b_ro; }
        else if(sel==='st'){ a=a_st; b=b_st; }
        return {a:clamp(a,0,1), b:clamp(b,0,1), tag: sel};
      }
      function calcIFCoppia(){
        const norm=s=>Number.isFinite(s)?(clamp(s,1,5)-1)/4:0;
        const p1_qi5=getLikert("1qi5"), p1_qo5=getLikert("1qo5");
        const p2_qi5=getLikert("2qi5"), p2_qo5=getLikert("2qo5");
        const IFP1=norm(p1_qi5)+norm(p1_qo5), IFP2=norm(p2_qi5)+norm(p2_qo5);
        return (((IFP1+IFP2)/2)-1)*100;
      }
      function renderCoppia(){
        const svg=byId("svg3"); if(!svg) return;
        const {cx,cy,R}=drawFrame(svg);

        const p1_id=calcIdentityAngle(getLikert("1qi1"),getLikert("1qi2"),getLikert("1qi3"),getLikert("1qi4"));
        const p1_or=calcOrientationAngle(getLikert("1qo1"),getLikert("1qo2"),getLikert("1qo3"),getLikert("1qo4"));
        const p1IM=(rescale(getLikert("1qi1"))||0)+(rescale(getLikert("1qi3"))||0);
        const p1IF=(rescale(getLikert("1qi2"))||0)+(rescale(getLikert("1qi4"))||0);
        const p1OM=(rescale(getLikert("1qo1"))||0)+(rescale(getLikert("1qo3"))||0);
        const p1OF=(rescale(getLikert("1qo2"))||0)+(rescale(getLikert("1qo4"))||0);

        const p2_id=calcIdentityAngle(getLikert("2qi1"),getLikert("2qi2"),getLikert("2qi3"),getLikert("2qi4"));
        const p2_or=calcOrientationAngle(getLikert("2qo1"),getLikert("2qo2"),getLikert("2qo3"),getLikert("2qo4"));
        const p2IM=(rescale(getLikert("2qi1"))||0)+(rescale(getLikert("2qi3"))||0);
        const p2IF=(rescale(getLikert("2qi2"))||0)+(rescale(getLikert("2qi4"))||0);
        const p2OM=(rescale(getLikert("2qo1"))||0)+(rescale(getLikert("2qo3"))||0);
        const p2OF=(rescale(getLikert("2qo2"))||0)+(rescale(getLikert("2qo4"))||0);

        
                // --- COPPIE: etichette P1/P2, bicolore e regole agli estremi (individuale lasciato invariato) ---
                const hasP1Id = (p1IM+p1IF>0);
                const hasP2Id = (p2IM+p2IF>0);
                const hasP1Or = (p1OM+p1OF>0);
                const hasP2Or = (p2OM+p2OF>0);

                (function(){
                  const fNodes = Array.from(svg.querySelectorAll('circle[fill="#fdd835"]'));
                  for(const c of fNodes){
                    svg.insertBefore(c, svg.firstChild);
                  }
                })();

                function handleExtreme(angle){
                  const present = [];
                  if(hasP1Id && ( (angle===180 && isNear180(p1_id)) || (angle===0 && isNear0or360(p1_id)) ))
                    present.push({lbl:"P1_Id", col:"#e53935"});
                  if(hasP2Id && ( (angle===180 && isNear180(p2_id)) || (angle===0 && isNear0or360(p2_id)) ))
                    present.push({lbl:"P2_Id", col:"#1e88e5"});
                  if(hasP1Or && ( (angle===180 && isNear180(p1_or)) || (angle===0 && isNear0or360(p1_or)) ))
                    present.push({lbl:"P1_Or", col:"#e53935"});
                  if(hasP2Or && ( (angle===180 && isNear180(p2_or)) || (angle===0 && isNear0or360(p2_or)) ))
                    present.push({lbl:"P2_Or", col:"#1e88e5"});

                  if(present.length===0) return false;

                  const p = polar(cx,cy,R,angle);
                  if(present.length===1){
                    const only = present[0];
                    drawPoint(svg,cx,cy,R,angle,only.col,only.lbl);
                    return true;
                  }

                  const uniq = [...new Set(present.map(o=>o.col))];
                  if(present.length>=3){
                    drawSolidPoint(svg,p.x,p.y,5,"#9e9e9e");
                  } else if(present.length===2){
                    if(uniq.length===1){
                      drawSolidPoint(svg,p.x,p.y,5,uniq[0]);
                    } else {
                      drawBiColorPoint(svg,p.x,p.y,5,"#e53935","#1e88e5");
                    }
                  }
                  const p1Labels = present.filter(o=>o.lbl.startsWith("P1")).map(o=>o.lbl);
                  const p2Labels = present.filter(o=>o.lbl.startsWith("P2")).map(o=>o.lbl);
                  for(const L of p1Labels) placeLabel(svg,p.x,p.y,L);
                  for(const L of p2Labels) placeLabel(svg,p.x,p.y,L);
                  return true;
                }

                const handled0   = handleExtreme(0);
                const handled180 = handleExtreme(180);

                function drawIdSide(){
                  const a1 = p1_id, a2 = p2_id;
                  const skip1 = handled0 && isNear0or360(a1) || handled180 && isNear180(a1);
                  const skip2 = handled0 && isNear0or360(a2) || handled180 && isNear180(a2);
                  if(hasP1Id && hasP2Id && !skip1 && !skip2 && near(a1,a2)){
                    const p = polar(cx,cy,R,(a1+a2)/2);
                    drawBiColorPoint(svg,p.x,p.y,5,"#e53935","#1e88e5");
                    placeLabel(svg,p.x,p.y,"P1_Id");
                    placeLabel(svg,p.x,p.y,"P2_Id");
                  } else {
                    if(hasP1Id && !skip1) drawPoint(svg,cx,cy,R,a1,"#e53935","P1_Id");
                    if(hasP2Id && !skip2) drawPoint(svg,cx,cy,R,a2,"#1e88e5","P2_Id");
                  }
                }
                function drawOrSide(){
                  const a1 = p1_or, a2 = p2_or;
                  const skip1 = handled0 && isNear0or360(a1) || handled180 && isNear180(a1);
                  const skip2 = handled0 && isNear0or360(a2) || handled180 && isNear180(a2);
                  if(hasP1Or && hasP2Or && !skip1 && !skip2 && near(a1,a2)){
                    const p = polar(cx,cy,R,(a1+a2)/2);
                    drawBiColorPoint(svg,p.x,p.y,5,"#e53935","#1e88e5");
                    placeLabel(svg,p.x,p.y,"P1_Or");
                    placeLabel(svg,p.x,p.y,"P2_Or");
                  } else {
                    if(hasP1Or && !skip1) drawPoint(svg,cx,cy,R,a1,"#e53935","P1_Or");
                    if(hasP2Or && !skip2) drawPoint(svg,cx,cy,R,a2,"#1e88e5","P2_Or");
                  }
                }
                drawIdSide();
                drawOrSide();
        const IA  = (1 - (diff180(p1_id,p2_id)/180)) * 100;
        const ICl = (diff180(p1_or,p2_or)/180) * 100; // range largo
        const dOr = diff180(p1_or,p2_or);
        const ICro= Math.exp(- Math.pow(dOr - 105, 2) / (2 * Math.pow(20, 2))) * 100;

        const selAB = readPairABBySelection();
        const IRpct = (selAB.a*(IA/100) + selAB.b*(ICl/100)) * 100;

        byId("pair-metrics").innerHTML = `
          <div><b>IA – Indice di Affinità di coppia (%):</b> ${Number.isFinite(IA)?IA.toFixed(1):"—"}</div>
          <div><b>ICl – Indice di Complementarietà di coppia range largo 180°–360° (%):</b> ${Number.isFinite(ICl)?ICl.toFixed(1):"—"}</div>
          <div><b>ICro – indice di Complementarietà di coppia nel range ottimale 90°–120° (%):</b> ${Number.isFinite(ICro)?ICro.toFixed(1):"—"}</div>
          <div><b>IR– Indice Relazionale (α=${selAB.a.toFixed(2)}, β=${selAB.b.toFixed(2)}) (%):</b> ${Number.isFinite(IRpct)?IRpct.toFixed(1):"—"}</div>
          <div><b>IF – Indice di Fluidità della coppia (%):</b> ${calcIFCoppia().toFixed(1)}</div>
          <div class="legend" style="margin-top:8px">
            Legenda: P1_Id = risultato identità partner 1; P1_Or = orientamento partner 1; P2_Id = identità partner 2; P2_Or = orientamento partner 2.
          </div>
        `;
      }
      function resetCoppia(){
        $$('#form3 input[type="radio"]').forEach(i=>i.checked=false);
        if(byId('alpha-am')) byId('alpha-am').value="0.8";
        if(byId('beta-am'))  byId('beta-am').value ="0.2";
        if(byId('alpha-ro')) byId('alpha-ro').value="0.4";
        if(byId('beta-ro'))  byId('beta-ro').value ="0.6";
        if(byId('alpha-st')) byId('alpha-st').value="0.6";
        if(byId('beta-st'))  byId('beta-st').value ="0.4";
        if(byId('rel-type')) byId('rel-type').value="am";
        renderCoppia();
      }

      /* ===== Sezione 4: Gruppo ===== */
      function readGroupAB(){
        let a=byId('alpha-gr')?.valueAsNumber ?? 0.8;
        let b=byId('beta-gr') ?.valueAsNumber ?? 0.2;
        return {a:clamp(a,0,1), b:clamp(b,0,1)};
      }
      
function renderGruppo(){
  const svg = byId("svg4"); if(!svg) return;
  const {cx,cy,R} = drawFrame(svg);

  // Sposta i cerchi F gialli in fondo al DOM (sotto a tutto)
  (function(){
    const fNodes = Array.from(svg.querySelectorAll('circle[fill="#fdd835"]'));
    for(const c of fNodes){ svg.insertBefore(c, svg.firstChild); }
  })();

  // Lettura angoli e presenze
  const g1_id = calcIdentityAngle(getLikert("g1qi1"),getLikert("g1qi2"),getLikert("g1qi3"),getLikert("g1qi4"));
  const g1_or = calcOrientationAngle(getLikert("g1qo1"),getLikert("g1qo2"),getLikert("g1qo3"),getLikert("g1qo4"));
  const g1IM=(rescale(getLikert("g1qi1"))||0)+(rescale(getLikert("g1qi3"))||0);
  const g1IF=(rescale(getLikert("g1qi2"))||0)+(rescale(getLikert("g1qi4"))||0);
  const g1OM=(rescale(getLikert("g1qo1"))||0)+(rescale(getLikert("g1qo3"))||0);
  const g1OF=(rescale(getLikert("g1qo2"))||0)+(rescale(getLikert("g1qo4"))||0);

  const g2_id = calcIdentityAngle(getLikert("g2qi1"),getLikert("g2qi2"),getLikert("g2qi3"),getLikert("g2qi4"));
  const g2_or = calcOrientationAngle(getLikert("g2qo1"),getLikert("g2qo2"),getLikert("g2qo3"),getLikert("g2qo4"));
  const g2IM=(rescale(getLikert("g2qi1"))||0)+(rescale(getLikert("g2qi3"))||0);
  const g2IF=(rescale(getLikert("g2qi2"))||0)+(rescale(getLikert("g2qi4"))||0);
  const g2OM=(rescale(getLikert("g2qo1"))||0)+(rescale(getLikert("g2qo3"))||0);
  const g2OF=(rescale(getLikert("g2qo2"))||0)+(rescale(getLikert("g2qo4"))||0);

  const g3_id = calcIdentityAngle(getLikert("g3qi1"),getLikert("g3qi2"),getLikert("g3qi3"),getLikert("g3qi4"));
  const g3_or = calcOrientationAngle(getLikert("g3qo1"),getLikert("g3qo2"),getLikert("g3qo3"),getLikert("g3qo4"));
  const g3IM=(rescale(getLikert("g3qi1"))||0)+(rescale(getLikert("g3qi3"))||0);
  const g3IF=(rescale(getLikert("g3qi2"))||0)+(rescale(getLikert("g3qi4"))||0);
  const g3OM=(rescale(getLikert("g3qo1"))||0)+(rescale(getLikert("g3qo3"))||0);
  const g3OF=(rescale(getLikert("g3qo2"))||0)+(rescale(getLikert("g3qo4"))||0);

  const has = {
    P1Id: (g1IM+g1IF>0), P1Or:(g1OM+g1OF>0),
    P2Id: (g2IM+g2IF>0), P2Or:(g2OM+g2OF>0),
    P3Id: (g3IM+g3IF>0), P3Or:(g3OM+g3OF>0)
  };

  // mapping colori richiesti: P1 rosso, P2 blu, P3 giallo
  const COL = {P1:"#e53935", P2:"#1e88e5", P3:"#fdd835"};

  // utilità
  function toXY(deg){
    return polar(cx,cy,R,deg);
  }
  function drawTriColorPoint(svg,x,y,r,colors){
    // 3 settori da -90° a 30°, 30° a 150°, 150° a 270°
    function pth(a0,a1){
      const rad = Math.PI/180;
      const x1 = x + r*Math.cos(a0*rad), y1 = y - r*Math.sin(a0*rad);
      const x2 = x + r*Math.cos(a1*rad), y2 = y - r*Math.sin(a1*rad);
      const laf = ((a1-a0)%360) > 180 ? 1 : 0;
      const sw = 0; // CCW per coerenza con polar (y inversa)
      return `M ${x} ${y} L ${x1} ${y1} A ${r} ${r} 0 ${laf} ${sw} ${x2} ${y2} Z`;
    }
    const paths = [
      {d:pth(-90,30),   fill:colors[0]},
      {d:pth(30,150),   fill:colors[1]},
      {d:pth(150,270),  fill:colors[2]},
    ];
    for(const seg of paths) svg.appendChild(svgEl("path",seg));
  }

  // collezione punti (separiamo Id e Or per etichette/ordine P1->P2->P3)
  const pts = [];
  if(has.P1Id) pts.push({kind:"Id", person:"P1", deg:g1_id, color:COL.P1, label:"P1_Id"});
  if(has.P2Id) pts.push({kind:"Id", person:"P2", deg:g2_id, color:COL.P2, label:"P2_Id"});
  if(has.P3Id) pts.push({kind:"Id", person:"P3", deg:g3_id, color:COL.P3, label:"P3_Id"});

  if(has.P1Or) pts.push({kind:"Or", person:"P1", deg:g1_or, color:COL.P1, label:"P1_Or"});
  if(has.P2Or) pts.push({kind:"Or", person:"P2", deg:g2_or, color:COL.P2, label:"P2_Or"});
  if(has.P3Or) pts.push({kind:"Or", person:"P3", deg:g3_or, color:COL.P3, label:"P3_Or"});

  const consumed = new Set();

  // Gestione estremi con regola "grigio" se miste semicirconferenze
  function handleExtreme(angle){
    const at = pts.filter((p,i)=>{ if(near(p.deg,angle,2)||isNear0or360(p.deg)&&isNear0or360(angle)) return !consumed.has(i); else return false; })
                  .map((p,i)=>({...p, index: pts.indexOf(p)}));
    if(at.length===0) return;

    const hasId = at.some(p=>p.kind==="Id");
    const hasOr = at.some(p=>p.kind==="Or");
    const {x,y} = toXY(angle);

    if(hasId && hasOr){
      // semicirconferenze diverse -> grigio
      drawSolidPoint(svg,x,y,5,"#9e9e9e");
    }else{
      // stessa semicirconferenza -> bi/tri colore
      const cols = Array.from(new Set(at.map(p=>p.color)));
      if(cols.length===1){
        drawSolidPoint(svg,x,y,5,cols[0]);
      }else if(cols.length===2){
        drawBiColorPoint(svg,x,y,5,cols[0],cols[1]);
      }else{
        drawTriColorPoint(svg,x,y,5,[cols[0],cols[1],cols[2]]);
      }
    }
    // Etichette: P1 -> P2 -> P3
    ["P1","P2","P3"].forEach(tag=>{
      at.filter(p=>p.person===tag).forEach(p=>{
        placeLabel(svg,x,y,p.label);
      });
    });
    at.forEach(p=>consumed.add(p.index));
  }

  handleExtreme(0);
  handleExtreme(180);

  // Gruppi non estremi per Id e Or separati
  function drawGroups(kind){
    const arr = pts.map((p,i)=>({...p,index:i})).filter(p=>p.kind===kind && !consumed.has(p.index));
    // cluster per angoli vicini
    arr.sort((a,b)=>norm360(a.deg)-norm360(b.deg));
    const groups=[];
    for(const p of arr){
      let g = groups.find(gr=>Math.abs(norm360(gr.deg)-norm360(p.deg))<=2);
      if(!g){ g={deg:p.deg, items:[]}; groups.push(g); }
      g.items.push(p);
    }
    for(const g of groups){
      const {x,y} = toXY(g.deg);
      const cols = Array.from(new Set(g.items.map(p=>p.color)));
      if(cols.length===1){
        drawSolidPoint(svg,x,y,5,cols[0]);
      }else if(cols.length===2){
        drawBiColorPoint(svg,x,y,5,cols[0],cols[1]);
      }else{
        drawTriColorPoint(svg,x,y,5,[cols[0],cols[1],cols[2]]);
      }
      // etichette nell'ordine P1->P2->P3
      ["P1","P2","P3"].forEach(tag=>{
        g.items.filter(p=>p.person===tag).forEach(p=>{
          placeLabel(svg,x,y,p.label);
          consumed.add(p.index);
        });
      });
    }
  }
  drawGroups("Id");
  drawGroups("Or");

  // ===== Calcolo indici di gruppo (lasciato invariato) =====
  const valid=(id,or)=>Number.isFinite(id)&&Number.isFinite(or);
  const P1={id:g1_id,or:g1_or,ok:valid(g1_id,g1_or)};
  const P2={id:g2_id,or:g2_or,ok:valid(g2_id,g2_or)};
  const P3={id:g3_id,or:g3_or,ok:valid(g3_id,g3_or)};

  const pairs=[];
  if(P1.ok&&P2.ok) pairs.push({A:P1,B:P2});
  if(P1.ok&&P3.ok) pairs.push({A:P1,B:P3});
  if(P2.ok&&P3.ok) pairs.push({A:P2,B:P3});

  const m = byId("group-metrics");
  if(pairs.length===0){ m.textContent=""; return; }

  function diff180(a,b){ const d=Math.abs(norm360(a)-norm360(b)); return d>180?360-d:d; }

  let sumIA=0, sumIC=0;
  pairs.forEach(({A,B})=>{
    sumIA += (1 - (diff180(A.id,B.id)/180)) * 100;
    sumIC += (diff180(A.or,B.or)/180) * 100;
  });
  const IA = sumIA/pairs.length;
  const IC = sumIC/pairs.length;
  const {a,b}=readGroupAB();
  const IR = (a*(IA/100) + b*(IC/100)) * 100;

  m.innerHTML = `
    <div><b>Indice di Affinità di gruppo (IA) in %:</b> ${Number.isFinite(IA)?IA.toFixed(1):"—"}</div>
    <div><b>Indice di Complementarietà (IC) di gruppo (%):</b> ${Number.isFinite(IC)?IC.toFixed(1):"—"}</div>
    <div><b>Indice Relazionale di gruppo (IR) (α=${a.toFixed(2)}; β=${b.toFixed(2)}) in %:</b> ${Number.isFinite(IR)?IR.toFixed(1):"—"}</div>
  `;
  try{ resolvePointLabelCollisions(svg); }catch(e){};

}

      function resetGruppo(){
        $$('#form4 input[type="radio"]').forEach(i=>i.checked=false);
        if(byId('alpha-gr')) byId('alpha-gr').value="0.8";
        if(byId('beta-gr'))  byId('beta-gr').value ="0.2";
        renderGruppo();
      }

      /* ===== Reset Totale & Export ===== */
      function resetAll(){ resetVisivo(); resetInd(); resetCoppia(); resetGruppo(); }
      window.resetAll   = resetAll;
      window.resetVisivo= resetVisivo;
      window.resetInd   = resetInd;
      window.resetCoppia= resetCoppia;
      window.resetGruppo= resetGruppo;

      /* ===== Eventi ===== */
      // Test visivo: input libero durante digitazione; clamp su change
      if(byId("vis-id")){
        byId("vis-id").addEventListener("input", ()=>renderVisivo());
        byId("vis-id").addEventListener("change", e=>{
          const v=e.target.valueAsNumber;
          if(Number.isFinite(v)) e.target.value = clamp(v,0,180);
          renderVisivo();
        });
      }
      if(byId("vis-or")){
        byId("vis-or").addEventListener("input", ()=>renderVisivo());
        byId("vis-or").addEventListener("change", e=>{
          const v=e.target.valueAsNumber;
          if(Number.isFinite(v)) e.target.value = clamp(v,180,360);
          renderVisivo();
        });
      }

      // Ricalcolo automatico su ogni risposta e su α/β (coppia e gruppo)
      document.addEventListener("change", ev=>{
        const t=ev.target; if(!t) return;
        if(t.matches('input[type="radio"]')){ renderInd(); renderCoppia(); renderGruppo(); }
        if(t.id==='rel-type' || t.id==='alpha-am' || t.id==='beta-am' || t.id==='alpha-ro' || t.id==='beta-ro' || t.id==='alpha-st' || t.id==='beta-st'){
          renderCoppia();
        }
        if(t.id==='alpha-gr' || t.id==='beta-gr'){ renderGruppo(); }
      });

      // Bootstrap iniziale
      function boot(){ renderVisivo(); renderInd(); renderCoppia(); renderGruppo(); }
      if(document.readyState==="loading") document.addEventListener("DOMContentLoaded", boot); else boot();
    })();
    </script>
